"use strict";(self.wpRiseJsonp=self.wpRiseJsonp||[]).push([["profiler"],{41989:(me,k,u)=>{u.r(k),u.d(k,{DEFAULT_RUM_PROFILER_CONFIGURATION:()=>E,createRumProfiler:()=>$});var w=u(58476),p=u(32950),j=u(50516),T=u(63960),F=u(52176),I=u(53543),y=u(16568);function U(e){let t=0;for(const o of e)o.stackId!==void 0&&t++;return t}const h=new Map;function pe(){h.clear()}function B(e,t){h.set(t,e)}function C(e){return h.get(e)}function P(e){for(const t of h.keys())t<e&&h.delete(t)}function V({rawRumEvent:e,startTime:t}){if(e.type!==y.bb.LONG_TASK)return;const o=e.long_task.id;B(o,t)}var J=u(11659),G=u(72582);function H(e,t,o){const r={application:{id:t}};o&&(r.session={id:o});const{ids:l,names:v}=x(e.views);l.length&&(r.view={id:l,name:v});const d=e.longTasks.map(m=>m.id).filter(m=>m!==void 0);return d.length&&(r.long_task={id:d}),r}function x(e){const t={ids:[],names:[]};for(const o of e)t.ids.push(o.viewId),o.viewName&&t.names.push(o.viewName);return t.names=Array.from(new Set(t.names)),t}const z=(e,t,o)=>{const{profilingEndpointBuilder:r,applicationId:l}=t,v=K(e,t,o),d=Z(e,v),m=r.build("fetch",d);return(0,J.A2)("Sending profile to public profiling intake",{profilingIntakeURL:m,applicationId:l,sessionId:o}),fetch(m,{body:d.data,method:"POST"})};function K(e,t,o){const r=(0,G.m5)(t),l=H(e,t.applicationId,o),v=X(r);return{...l,attachments:["wall-time.json"],start:new Date(e.startClocks.timeStamp).toISOString(),end:new Date(e.endClocks.timeStamp).toISOString(),family:"chrome",runtime:"chrome",format:"json",version:4,tags_profiler:v.join(","),_dd:{clock_drift:(0,p.TP)()}}}function X(e){return e.concat(["language:javascript","runtime:chrome","family:chrome","host:browser"])}function Z(e,t){const o=new Blob([JSON.stringify(e)],{type:"application/json"}),r=new FormData;return r.append("event",new Blob([JSON.stringify(t)],{type:"application/json"}),"event.json"),r.append("wall-time.json",o,"wall-time.json"),{data:r,bytesCount:0}}const Q={sendProfile:z},W=/\/(?![vV]\d{1,2}\/)([^/\d?]*\d+[^/?]*)/g;function Y(e){return e?e.replace(W,"/?"):"/"}const S=(e,t)=>e||Y(t),E={sampleIntervalMs:10,collectIntervalMs:6e4,minProfileDurationMs:5e3,minNumberOfSamples:50};function $(e,t,o,r,l=E){const v=(0,y.s5)(y.do.LONG_ANIMATION_FRAME);let d;const m=[];let i={state:"stopped"};function q(n){i.state!=="running"&&(d=n?{startClocks:n.startClocks,viewId:n.id,viewName:S(n.name,document.location.pathname)}:void 0,m.push((0,w.q)(e,window,"visibilitychange",se).stop,(0,w.q)(e,window,"beforeunload",oe).stop),b())}async function _(){await L("stopped"),m.forEach(n=>n()),P((0,p.M8)().relative),r.set({status:"stopped",error_reason:void 0})}function ee(n){if(n.state==="running")return{cleanupTasks:n.cleanupTasks,observer:n.observer};const s=[];let a;if(e.trackLongTasks){a=new PerformanceObserver(ne),a.observe({entryTypes:[re()]});const c=t.subscribe(12,g=>{V(g)});s.push(()=>a?.disconnect()),s.push(c.unsubscribe)}const f=t.subscribe(2,c=>{const g={viewId:c.id,viewName:S(c.name,document.location.pathname),startClocks:c.startClocks};N(g),d=g});return s.push(f.unsubscribe),{cleanupTasks:s,observer:a}}function b(){const n=(0,j.VZ)().Profiler;if(!n)throw r.set({status:"error",error_reason:"not-supported-by-browser"}),new Error("RUM Profiler is not supported in this browser.");O(i).catch(T.Dx);const{cleanupTasks:s,observer:a}=ee(i);let f;try{f=new n({sampleInterval:l.sampleIntervalMs,maxBufferSize:Math.round(l.collectIntervalMs*1.5/l.sampleIntervalMs)})}catch(c){c instanceof Error&&c.message.includes("disabled by Document Policy")?(F.Vy.warn("[DD_RUM] Profiler startup failed. Ensure your server includes the `Document-Policy: js-profiling` response header when serving HTML pages.",c),r.set({status:"error",error_reason:"missing-document-policy-header"})):r.set({status:"error",error_reason:"unexpected-exception"});return}r.set({status:"running",error_reason:void 0}),i={state:"running",startClocks:(0,p.M8)(),profiler:f,timeoutId:(0,I.wg)(b,l.collectIntervalMs),longTasks:[],views:[],cleanupTasks:s,observer:a},N(d),f.addEventListener("samplebufferfull",D)}async function O(n){var s,a;if(n.state!=="running")return;M((a=(s=n.observer)===null||s===void 0?void 0:s.takeRecords())!==null&&a!==void 0?a:[]),(0,I.DJ)(n.timeoutId),n.profiler.removeEventListener("samplebufferfull",D);const{startClocks:f,longTasks:c,views:g}=n,ce=(0,p.M8)();await n.profiler.stop().then(R=>{const A=(0,p.M8)(),ue=c.length>0,de=(0,p.vk)(f.timeStamp,A.timeStamp)<l.minProfileDurationMs,fe=U(R.samples)<l.minNumberOfSamples;!ue&&(de||fe)||(te(Object.assign(R,{startClocks:f,endClocks:A,clocksOrigin:(0,p.Oc)(),longTasks:c,views:g,sampleInterval:l.sampleIntervalMs})),P(ce.relative))}).catch(T.Dx)}async function L(n){i.state==="running"&&(i.cleanupTasks.forEach(s=>s()),await O(i),i={state:n})}function N(n){i.state!=="running"||!n||i.views.push(n)}function te(n){var s;const a=(s=o.findTrackedSession())===null||s===void 0?void 0:s.id;Q.sendProfile(n,e,a).catch(T.Dx)}function D(){b()}function ne(n){M(n.getEntries())}function M(n){if(i.state==="running")for(const s of n){if(s.duration<l.sampleIntervalMs)continue;const a=(0,p.FR)(s.startTime),f=C(a.relative);i.longTasks.push({id:f,duration:s.duration,entryType:s.entryType,startClocks:a})}}function se(){document.visibilityState==="hidden"&&i.state==="running"?L("paused").catch(T.Dx):document.visibilityState==="visible"&&i.state==="paused"&&b()}function oe(){b()}function re(){return v?"long-animation-frame":"longtask"}function ie(){return i.state==="stopped"}function ae(){return i.state==="running"}function le(){return i.state==="paused"}return{start:q,stop:_,isStopped:ie,isRunning:ae,isPaused:le}}}}]);
